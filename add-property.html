// ملف: add-property-script.js
// كود JavaScript الخاص بصفحة إضافة عقار - مع دعم حفظ البيانات

document.addEventListener('DOMContentLoaded', function() {
    console.log('صفحة إضافة عقار جاهزة');
    
    // متغيرات رفع الصور
    const uploadArea = document.getElementById('uploadArea');
    const imageUpload = document.getElementById('imageUpload');
    const uploadedImagesContainer = document.getElementById('uploadedImages');
    let uploadedFiles = [];
    
    // ===== 1. تفعيل رفع الصور =====
    if(uploadArea) {
        uploadArea.addEventListener('click', function() {
            imageUpload.click();
        });
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#4a6fa5';
            uploadArea.style.backgroundColor = '#f0f5ff';
        });
        
        uploadArea.addEventListener('dragleave', function() {
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.backgroundColor = '#f9f9f9';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.backgroundColor = '#f9f9f9';
            handleImageFiles(e.dataTransfer.files);
        });
    }
    
    if(imageUpload) {
        imageUpload.addEventListener('change', function(e) {
            handleImageFiles(e.target.files);
        });
    }
    
    function handleImageFiles(files) {
        const maxFiles = 5;
        
        if(uploadedFiles.length + files.length > maxFiles) {
            alert(`يمكنك رفع ${maxFiles} صور كحد أقصى. لديك ${uploadedFiles.length} صور مرفوعة بالفعل.`);
            return;
        }
        
        for(let i = 0; i < Math.min(files.length, maxFiles - uploadedFiles.length); i++) {
            const file = files[i];
            
            if(!file.type.match('image.*')) {
                alert('الملف ' + file.name + ' ليس صورة. سيتم تخطيه.');
                continue;
            }
            
            if(file.size > 5 * 1024 * 1024) {
                alert('الملف ' + file.name + ' كبير جداً (الحد الأقصى 5MB). سيتم تخطيه.');
                continue;
            }
            
            uploadedFiles.push(file);
            displayUploadedImage(file);
        }
        
        if(imageUpload) imageUpload.value = '';
    }
    
    function displayUploadedImage(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'uploaded-image-item';
            
            imgContainer.innerHTML = `
                <img src="${e.target.result}" alt="معاينة">
                <button type="button" class="remove-image" data-name="${file.name}">
                    <i class="fas fa-times"></i>
                </button>
                <span>${file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name}</span>
            `;
            
            uploadedImagesContainer.appendChild(imgContainer);
            
            const removeBtn = imgContainer.querySelector('.remove-image');
            removeBtn.addEventListener('click', function() {
                const fileName = this.getAttribute('data-name');
                uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
                imgContainer.remove();
            });
        };
        
        reader.readAsDataURL(file);
    }
    
    // ===== 2. تفعيل إرسال النموذج وحفظ العقار =====
    const propertyForm = document.getElementById('propertyForm');
    
    if(propertyForm) {
        propertyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // جمع بيانات النموذج
            const propertyData = {
                id: Date.now(),
                name: document.getElementById('propertyName').value,
                type: document.getElementById('propertyType').value,
                transaction: document.getElementById('transactionType').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                price: document.getElementById('price').value,
                area: document.getElementById('area').value || 'غير محدد',
                rooms: document.getElementById('rooms').value,
                description: document.getElementById('description').value,
                contactName: document.getElementById('contactName').value,
                contactPhone: document.getElementById('contactPhone').value,
                contactEmail: document.getElementById('contactEmail').value,
                date: new Date().toLocaleDateString('ar-MA'),
                image: 'https://imadxhabja-lang.github.io/Darmarket/icons/icon-512x512.png' // صورة افتراضية
            };
            
            // التحقق من الحقول المطلوبة
            if(!propertyData.name || !propertyData.city || !propertyData.price || 
               !propertyData.contactName || !propertyData.contactPhone) {
                alert('الرجاء ملء جميع الحقول المطلوبة (العلامة النجمية)');
                return;
            }
            
            // إظهار مؤشر التحميل
            const loadingSpinner = document.getElementById('loadingSpinner');
            if(loadingSpinner) loadingSpinner.style.display = 'flex';
            
            // حفظ العقار في localStorage
            setTimeout(function() {
                let properties = [];
                const storedProperties = localStorage.getItem('darmarket_properties');
                
                if(storedProperties) {
                    properties = JSON.parse(storedProperties);
                }
                
                properties.push(propertyData);
                localStorage.setItem('darmarket_properties', JSON.stringify(properties));
                
                console.log('تم حفظ العقار. العدد الإجمالي:', properties.length);
                
                // إخفاء مؤشر التحميل
                if(loadingSpinner) loadingSpinner.style.display = 'none';
                
                // عرض رسالة النجاح
                const confirmationModal = document.getElementById('confirmationModal');
                if(confirmationModal) {
                    confirmationModal.style.display = 'flex';
                }
                
                // إعادة تعيين النموذج
                propertyForm.reset();
                uploadedFiles = [];
                uploadedImagesContainer.innerHTML = '';
                
            }, 1000);
        });
    }
    
    // ===== 3. زر إضافة عقار آخر =====
    const addAnotherBtn = document.getElementById('addAnotherBtn');
    if(addAnotherBtn) {
        addAnotherBtn.addEventListener('click', function() {
            const confirmationModal = document.getElementById('confirmationModal');
            if(confirmationModal) {
                confirmationModal.style.display = 'none';
            }
        });
    }
});
